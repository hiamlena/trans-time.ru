<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TT Diag</title>
<style>
  body{font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:16px;background:#0b1020;color:#e5e7eb}
  .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}.muted{opacity:.7}
  pre{white-space:pre-wrap;word-break:break-word;background:#0f172a;border:1px solid #1f2a44;padding:10px;border-radius:8px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{border:1px solid #1f2a44;padding:12px;border-radius:10px;background:#0f172a;min-width:260px}
</style>
</head>
<body>
<h2>Trans-Time ‚Äî –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h2>

<div class="row">
  <div class="card"><b>–î–æ–∫. –∑–∞–≥–æ–ª–æ–≤–∫–∏ (CSP)</b><pre id="hdrs">—á–∏—Ç–∞—é‚Ä¶</pre></div>
  <div class="card"><b>–°–µ—Ç—å</b><pre id="net">–ø—Ä–æ–≤–µ—Ä—è—é‚Ä¶</pre></div>
  <div class="card"><b>Yandex API</b><pre id="ya">–∂–¥—É‚Ä¶</pre></div>
  <div class="card"><b>JS-–æ—à–∏–±–∫–∏</b><pre id="js">–ø–æ–∫–∞ –Ω–µ—Ç</pre></div>
</div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const log = (id, msg, cls='')=>{
    const el = $(id);
    el.innerHTML += (el.textContent.trim()?'\n':'') + msg;
    if(cls) el.className = cls;
  };

  // 1) –°–æ–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–∫–ª–∏–∫–æ–º –Ω–∞ HEAD
  fetch(location.href, {method:'HEAD', cache:'no-store'}).then(r=>{
    const csp = r.headers.get('content-security-policy') || '(–Ω–µ—Ç CSP –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ)';
    const ro = r.headers.get('content-security-policy-report-only');
    const lines = [`CSP: ${csp}`];
    if (ro) lines.push(`CSP-Report-Only: ${ro}`);
    $('#hdrs').textContent = lines.join('\n');
  }).catch(e=>$('#hdrs').textContent = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: '+e);

  // 2) –ü–∏–Ω–≥—É–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–æ–º–µ–Ω—ã ‚Äî –ø–æ–π–º—ë–º, —á—Ç–æ –±–ª–æ—á–∏—Ç CSP
  async function ping(url){
    try{
      const r = await fetch(url, {mode:'no-cors', cache:'no-store'});
      return {url, ok:true};
    }catch(e){return {url, ok:false, err:String(e)}}
  }
  (async ()=>{
    const targets = [
      'https://api-maps.yandex.ru/2.1/?lang=ru_RU',
      'https://yastatic.net',
      'https://core-renderer-tiles.maps.yandex.net',
      'https://geocode-maps.yandex.ru',
      'https://router-maps.yandex.ru',
      // —Ç–µ—Å—Ç –∫—É—Ä—Å–æ—Ä–∞ (—á–∞—Å—Ç–æ –±–ª–æ—á–∏—Ç—Å—è img-src)
      'https://yastatic.net/s3/front-maps-static/maps-front-jsapi-v2-1/2.1.79-17809409/out/release/images/cursor/grab.cur'
    ];
    const results = await Promise.all(targets.map(ping));
    $('#net').textContent = results.map(r => `${r.ok?'‚úÖ':'‚õî'} ${r.url}`).join('\n');
  })();

  // 3) –õ–æ–≤–∏–º –æ—à–∏–±–∫–∏ JS –∏ CSP-violations
  const jsbox = $('#js');
  window.addEventListener('error', e=>{
    jsbox.textContent += `\n‚ùå ${e.message} @ ${e.filename}:${e.lineno}`;
  });
  window.addEventListener('unhandledrejection', e=>{
    jsbox.textContent += `\n‚ö†Ô∏è Unhandled: ${(e.reason && (e.reason.stack||e.reason.message)) || e.reason}`;
  });
  document.addEventListener('securitypolicyviolation', e=>{
    jsbox.textContent += `\nüõ°Ô∏è CSP block: ${e.violatedDirective} ‚Üí ${e.blockedURI}`;
  });

  // 4) –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É Yandex API (–±–µ–∑ –∫–ª—é—á–∞, –ø—Ä–æ—Å—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å)
  const s = document.createElement('script');
  s.src = 'https://api-maps.yandex.ru/2.1/?lang=ru_RU';
  s.onload = ()=>{ $('#ya').textContent = '‚úÖ Yandex API –¥–æ—Å—Ç—É–ø–µ–Ω (–±–µ–∑ –∫–ª—é—á–∞)'; };
  s.onerror = ()=>{ $('#ya').textContent = '‚õî –ù–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è Yandex API (—Å–º. CSP/—Å–µ—Ç—å)'; };
  document.head.appendChild(s);
})();
</script>
</body>
</html>
